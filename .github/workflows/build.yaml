name: Build ESP32-C3 SuperMini Firmware

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout board configuration
        uses: actions/checkout@v4
        with:
          path: board-config

      - name: Checkout xiaozhi-esp32 source
        uses: actions/checkout@v4
        with:
          repository: samnelking/xiaozhi-esp32
          path: xiaozhi-esp32
          submodules: recursive

      - name: Setup board configuration
        run: |
          mkdir -p xiaozhi-esp32/main/boards/esp32c3-supermini
          cp board-config/config.h xiaozhi-esp32/main/boards/esp32c3-supermini/
          cp board-config/config.json xiaozhi-esp32/main/boards/esp32c3-supermini/
          cp board-config/esp32c3_supermini_board.cc xiaozhi-esp32/main/boards/esp32c3-supermini/
          if [ -f "board-config/scripts/setup_board.py" ]; then
            python3 board-config/scripts/setup_board.py xiaozhi-esp32/main
          fi

      - name: Fix source code issues
        run: |
          echo "=== 执行所有必要的源码修复 ==="
          cd xiaozhi-esp32
          
          # 1. 列出当前目录文件，查看真实情况
          echo "当前目录文件列表:"
          ls -la | grep -E "(CMake|OkNet)" || echo "未找到相关文件"
          
          # 2. 修复文件名错误
          if ls | grep -q "CMaket.lsts.txt"; then
            echo "修复文件名: CMaket.lsts.txt -> CMakeLists.txt"
            mv "CMaket.lsts.txt" "CMakeLists.txt"
          fi
          
          # 3. 创建必需的文件
          echo "创建必需文件: OkNetists.txt"
          echo "# Auto-generated for build system" > OkNetists.txt
          
          # ========== 关键修复部分开始 ==========
          # 4. 修复源码问题 - 使用精确的行号匹配
          FILE="managed_components/espressif2022__esp_emote_gfx/src/core/gfx_refr.c"
          if [ -f "$FILE" ]; then
            echo "正在修复文件: $FILE"
            
            # 备份原文件
            cp "$FILE" "${FILE}.backup"
            
            # 查看第117行原始内容
            echo "第117行原始内容:"
            sed -n '117p' "$FILE"
            
            # 关键：使用精确的行号替换，不使用复杂的模式匹配
            # 直接修改第117行，将%d替换为%lu
            sed -i '117s/%d/%lu/g' "$FILE"
            
            # 再次查看第117行修复后内容
            echo "第117行修复后内容:"
            sed -n '117p' "$FILE"
            
            # 确保string.h头文件存在
            if ! grep -q '#include <string.h>' "$FILE"; then
              echo "添加缺失的string.h头文件"
              sed -i '/#include <stdlib.h>/a #include <string.h>' "$FILE"
            fi
            
            echo "✅ 文件修复完成"
          else
            echo "❌ 警告: 未找到文件 $FILE"
            # 尝试查找该文件
            find . -name "gfx_refr.c" -type f 2>/dev/null | head -5
          fi
          # ========== 关键修复部分结束 ==========
          
          # 5. 验证修复结果
          echo -e "\n验证修复结果:"
          echo "关键文件检查:"
          for file in CMakeLists.txt OkNetists.txt; do
            if [ -f "$file" ]; then
              echo "✅ $file 存在"
            else
              echo "❌ $file 不存在"
            fi
          done

      - name: Install ESP-IDF v5.4
        run: |
          echo "=== 安装 ESP-IDF v5.4 ==="
          sudo apt-get update
          sudo apt-get install -y git wget flex bison gperf python3 python3-pip python3-venv cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0
          
          # 安装到 /opt/esp-idf 目录
          mkdir -p /opt
          cd /opt
          git clone -b v5.4 --depth 1 https://github.com/espressif/esp-idf.git
          cd esp-idf
          ./install.sh esp32c3
          
          # 设置环境变量
          echo "IDF_PATH=/opt/esp-idf" >> $GITHUB_ENV
          echo "PATH=/opt/esp-idf/tools:$PATH" >> $GITHUB_ENV

      - name: Build Firmware
        run: |
          echo "=== 开始构建固件 ==="
          
          # 进入项目目录
          PROJECT_DIR="${{ github.workspace }}/xiaozhi-esp32"
          cd "$PROJECT_DIR"
          echo "当前目录: $(pwd)"
          
          # 验证关键文件
          echo -e "\n验证关键文件:"
          echo "当前目录内容:"
          ls -la | head -20
          
          echo -e "\n检查项目必需文件:"
          REQUIRED_FILES=("CMakeLists.txt" "OkNetists.txt")
          ALL_EXIST=true
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "✅ $file 存在"
            else
              echo "❌ $file 不存在"
              ALL_EXIST=false
            fi
          done
          
          # 检查idf.py命令可用性
          echo -e "\n检查idf.py命令可用性:"
          if command -v idf.py >/dev/null 2>&1; then
            echo "✅ idf.py命令可用"
            echo "idf.py位置: $(which idf.py)"
          else
            echo "❌ idf.py命令不可用"
            echo "PATH环境变量: $PATH"
            ALL_EXIST=false
          fi
          
          if [ "$ALL_EXIST" = false ]; then
            echo -e "\n错误: 缺少必需文件或命令"
            exit 1
          fi
          
          # 设置ESP-IDF环境
          echo -e "\n设置ESP-IDF环境..."
          . /opt/esp-idf/export.sh
          
          # 清理旧构建
          echo "清理旧构建..."
          rm -rf build sdkconfig
          
          # 设置目标芯片
          echo "设置目标芯片: esp32c3"
          idf.py set-target esp32c3
          
          # 应用自定义配置
          echo -e "\n应用自定义配置..."
          echo -e "\n# Append for ESP32-C3 SuperMini\nCONFIG_BOARD_TYPE_ESP32C3_SUPERMINI=y\nCONFIG_ESPTOOLPY_FLASHSIZE_4MB=y\nCONFIG_ESPTOOLPY_FLASHSIZE=\"4MB\"\nCONFIG_PARTITION_TABLE_CUSTOM=y\nCONFIG_PARTITION_TABLE_CUSTOM_FILENAME=\"partitions/v2/4m.csv\"\nCONFIG_ESP_WIFI_STATIC_RX_BUFFER_NUM=3\nCONFIG_ESP_WIFI_DYNAMIC_RX_BUFFER_NUM=4\nCONFIG_ESP_WIFI_AMPDU_TX_ENABLED=n\nCONFIG_ESP_WIFI_RX_BA_WIN=4\nCONFIG_COMPILER_OPTIMIZATION_SIZE=y\n# CONFIG_WAKE_WORD_DISABLED is not set\nCONFIG_USE_ESP_WAKE_WORD=y\nCONFIG_SR_WN_WN9S_NIHAOXIAOZHI=y\nCONFIG_COMPILER_WARNINGS_AS_ERRORS=n" >> sdkconfig
          
          # 重新配置
          echo -e "\n重新配置项目..."
          idf.py reconfigure
          
          # 开始构建
          echo "开始构建..."
          idf.py build
          
          # 验证构建结果
          echo -e "\n验证构建结果..."
          if [ -f "build/xiaozhi.bin" ]; then
            echo "✅ 固件构建成功！"
            echo "生成的文件:"
            find build -name "*.bin" -type f | head -10
          else
            echo "❌ 构建失败: 未找到 xiaozhi.bin"
            echo "构建目录内容:"
            ls -la build/ 2>/dev/null || echo "构建目录不存在"
            exit 1
          fi

      - name: Upload Firmware Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: esp32c3-supermini-firmware
          path: |
            xiaozhi-esp32/build/xiaozhi.bin
            xiaozhi-esp32/build/generated_assets.bin
            xiaozhi-esp32/build/bootloader/bootloader.bin
            xiaozhi-esp32/build/partition_table/partition-table.bin
          retention-days: 30
