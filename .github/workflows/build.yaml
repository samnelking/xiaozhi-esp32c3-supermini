name: Build ESP32-C3 SuperMini Firmware

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo (board config)
        uses: actions/checkout@v4
        with:
          path: board-config

      - name: Checkout xiaozhi-esp32 (source code)
        uses: actions/checkout@v4
        with:
          repository: samnelking/xiaozhi-esp32
          path: xiaozhi-esp32
          submodules: recursive

      - name: Setup board configuration
        run: |
          mkdir -p xiaozhi-esp32/main/boards/esp32c3-supermini
          cp board-config/config.h xiaozhi-esp32/main/boards/esp32c3-supermini/
          cp board-config/config.json xiaozhi-esp32/main/boards/esp32c3-supermini/
          cp board-config/esp32c3_supermini_board.cc xiaozhi-esp32/main/boards/esp32c3-supermini/
          if [ -f "board-config/scripts/setup_board.py" ]; then
            python3 board-config/scripts/setup_board.py xiaozhi-esp32/main
          fi

      - name: Fix source code issues
        run: |
          echo "=== 1. 检查并修复关键文件名 ==="
          cd xiaozhi-esp32
          
          # 核心修复：将错误的 CMaket.lsts.txt 重命名为正确的 CMakeLists.txt
          if [ -f "CMaket.lsts.txt" ]; then
            echo "发现错误命名的文件：CMaket.lsts.txt，正在重命名为 CMakeLists.txt"
            mv "CMaket.lsts.txt" "CMakeLists.txt"
          fi
          
          # 创建可能缺失的 OkNetists.txt 占位文件（如果需要）
          if [ ! -f "OkNetists.txt" ]; then
            echo "创建 OkNetists.txt 占位文件"
            echo "# Placeholder for build system" > OkNetists.txt
          fi
          
          echo -e "\n=== 2. 修复编译警告 ==="
          FILE_PATH="managed_components/espressif2022__esp_emote_gfx/src/core/gfx_refr.c"
          if [ -f "$FILE_PATH" ]; then
            echo "修复文件: $FILE_PATH"
            # 修复格式字符串
            sed -i '117s/"Merged area \[%d\] into \[%d\], saved %lu pixels"/"Merged area [%lu] into [%lu], saved %lu pixels"/' "$FILE_PATH"
            # 确保 string.h 存在
            if ! grep -q '#include <string.h>' "$FILE_PATH"; then
              sed -i '/#include <stdlib.h>/a #include <string.h>' "$FILE_PATH"
            fi
          fi
          
          echo -e "\n=== 3. 验证项目结构 ==="
          echo "关键文件检查："
          ls -la CMakeLists.txt idf.py 2>/dev/null || echo "警告：未找到关键文件"
          echo "当前目录: $(pwd)"

      - name: Setup ESP-IDF
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: v5.4
          target: esp32c3

      - name: Build Firmware
        run: |
          echo "构建步骤开始..."
          echo "工作空间: ${{ github.workspace }}"
          
          # 确保进入正确的项目目录
          PROJECT_DIR="${{ github.workspace }}/xiaozhi-esp32"
          cd "$PROJECT_DIR"
          echo "当前项目目录: $(pwd)"
          
          # 最终验证
          echo -e "\n验证项目文件："
          ls -la CMakeLists.txt idf.py 2>/dev/null && echo "✅ 项目文件就绪" || echo "❌ 缺少关键项目文件"
          
          echo -e "\n开始执行 idf.py build..."
          # 清理并设置目标
          rm -rf build sdkconfig
          idf.py set-target esp32c3
          
          # 应用您的自定义配置
          echo "" >> sdkconfig
          cat << EOF >> sdkconfig
# Append for ESP32-C3 SuperMini
CONFIG_BOARD_TYPE_ESP32C3_SUPERMINI=y
CONFIG_ESPTOOLPY_FLASHSIZE_4MB=y
CONFIG_ESPTOOLPY_FLASHSIZE="4MB"
CONFIG_PARTITION_TABLE_CUSTOM=y
CONFIG_PARTITION_TABLE_CUSTOM_FILENAME="partitions/v2/4m.csv"
CONFIG_ESP_WIFI_STATIC_RX_BUFFER_NUM=3
CONFIG_ESP_WIFI_DYNAMIC_RX_BUFFER_NUM=4
CONFIG_ESP_WIFI_AMPDU_TX_ENABLED=n
CONFIG_ESP_WIFI_RX_BA_WIN=4
CONFIG_COMPILER_OPTIMIZATION_SIZE=y
# CONFIG_WAKE_WORD_DISABLED is not set
CONFIG_USE_ESP_WAKE_WORD=y
CONFIG_SR_WN_WN9S_NIHAOXIAOZHI=y
CONFIG_COMPILER_WARNINGS_AS_ERRORS=n
EOF
          
          # 重新配置并构建
          idf.py reconfigure
          idf.py build
          
          # 验证输出
          if [ -f "build/xiaozhi.bin" ]; then
            echo -e "\n✅ 固件构建成功！"
            ls -lh build/*.bin | head -5
          else
            echo -e "\n❌ 构建失败，未找到输出文件"
            exit 1
          fi

      - name: Upload Firmware Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.run_number }}
          path: |
            xiaozhi-esp32/build/xiaozhi.bin
            xiaozhi-esp32/build/bootloader/bootloader.bin
            xiaozhi-esp32/build/partition_table/partition-table.bin
            xiaozhi-esp32/build/generated_assets.bin
          retention-days: 7
