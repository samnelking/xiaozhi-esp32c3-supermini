name: Build and Release ESP32-C3 SuperMini Firmware
on:
  push:
    tags:
      - 'v*'  # å®˜æ–¹æ¨èçš„æ ‡ç­¾è§¦å‘è§„åˆ™
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å‘å¸ƒReleaseéœ€è¦çš„æƒé™ï¼ˆå®˜æ–¹æ¨èï¼‰
    
    steps:
    - name: Checkout this repo
      uses: actions/checkout@v4
      with:
        path: board-config

    - name: Checkout xiaozhi-esp32
      uses: actions/checkout@v4
      with:
        repository: samnelking/xiaozhi-esp32
        path: xiaozhi-esp32
        submodules: recursive
        fetch-depth: 1
      timeout-minutes: 30

    - name: Setup board configuration
      run: |
        # å®˜æ–¹æ¨èçš„ç›®å½•åˆ›å»ºä¸æ–‡ä»¶å¤åˆ¶æ–¹å¼ï¼Œæ·»åŠ é”™è¯¯å¤„ç†
        mkdir -p xiaozhi-esp32/main/boards/esp32c3-supermini || { echo "åˆ›å»ºæ¿å¡ç›®å½•å¤±è´¥"; exit 1; }
        cp board-config/config.h xiaozhi-esp32/main/boards/esp32c3-supermini/ || { echo "å¤åˆ¶config.hå¤±è´¥"; exit 1; }
        cp board-config/config.json xiaozhi-esp32/main/boards/esp32c3-supermini/ || { echo "å¤åˆ¶config.jsonå¤±è´¥"; exit 1; }
        cp board-config/esp32c3_supermini_board.cc xiaozhi-esp32/main/boards/esp32c3-supermini/ || { echo "å¤åˆ¶board.ccå¤±è´¥"; exit 1; }
        python3 board-config/scripts/setup_board.py xiaozhi-esp32/main || { echo "æ¿å¡é…ç½®è„šæœ¬æ‰§è¡Œå¤±è´¥"; exit 1; }

    - name: Fix format string errors (å®˜æ–¹PRIå®è§„èŒƒ)
      run: |
        echo "=== ä¿®å¤æ ¼å¼ç¬¦ç±»å‹ä¸åŒ¹é…é—®é¢˜ ==="
        TARGET_FILES=(
          "gfx_refr.c"
          "gfx_obj.c"
          "font_puhui_30_4.c"
        )
        
        for file_pattern in "${TARGET_FILES[@]}"; do
          find xiaozhi-esp32 -name "$file_pattern" -type f | while read -r found_file; do
            echo "å¤„ç†æ–‡ä»¶: $found_file"
            
            # ä¿®å¤1ï¼šæ­£ç¡®æ·»åŠ inttypes.hï¼ˆESP-IDFå®˜æ–¹æ¨èçš„å¤´æ–‡ä»¶åŒ…å«æ ¼å¼ï¼‰
            if ! grep -q "#include <<inttypes.h>" "$found_file"; then
              sed -i '1i#include <<inttypes.h>' "$found_file"
              echo "âœ… å·²æ·»åŠ æ­£ç¡®çš„inttypes.hå¤´æ–‡ä»¶"
            fi
            
            # ä¿®å¤2ï¼šæ ¼å¼ç¬¦æ›¿æ¢ï¼ˆéµå¾ªC99æ ‡å‡†+ESP-IDFå®˜æ–¹å»ºè®®ï¼‰
            sed -i 's/%d/%" PRId32/g' "$found_file"       # int32_tå¯¹åº”PRId32
            sed -i 's/%lu/%" PRIul/g' "$found_file"      # unsigned longå¯¹åº”PRIul
            sed -i 's/\[%d\]/[%"" PRId32]/g' "$found_file" # æ•°ç»„ç´¢å¼•æ ¼å¼
            sed -i 's/\[%lu\]/[%"" PRIul]/g' "$found_file"
            sed -i 's/\$iu/%" PRIul/g' "$found_file"     # ç¬”è¯¯ä¿®å¤
          done
        done
        echo "=== æ ¼å¼ç¬¦ä¿®å¤å®Œæˆ ==="

    - name: Fix component compatibility (ESP32-C3 + ESP-IDF v5.4é€‚é…)
      run: |
        echo "=== å›¾å½¢ç»„ä»¶APIå…¼å®¹æ€§é€‚é… ==="
        GFX_SRC_DIR=$(find xiaozhi-esp32 -path "*/espressif2022__esp_emote_gfx/src" -type d)
        if [ -n "$GFX_SRC_DIR" ]; then
          echo "æ‰¾åˆ°å›¾å½¢ç»„ä»¶ç›®å½•: $GFX_SRC_DIR"
          
          # ä¿®å¤1ï¼šæ›¿æ¢ESP32ä¸“å±efuseå¤´æ–‡ä»¶ï¼ˆESP-IDF v5+æ ‡å‡†ï¼‰
          find "$GFX_SRC_DIR" -name "*.c" -o -name "*.h" | xargs sed -i 's/#include "esp_efuse_table.h"/#include "esp_efuse.h"/g'
          
          # ä¿®å¤2ï¼šæ›¿æ¢æ—§ç‰ˆI2Sé©±åŠ¨å¤´æ–‡ä»¶ï¼ˆESP-IDF v5+ä½¿ç”¨i2s_std.hï¼‰
          find "$GFX_SRC_DIR" -name "*.c" | xargs sed -i 's/#include "driver\/i2s.h"/#include "driver\/i2s_std.h"/g'
          
          # ä¿®å¤3ï¼šç§»é™¤å¤šæ ¸é…ç½®ï¼ˆESP32-C3ä¸ºå•æ ¸ï¼Œæ— CORE_AFFINITYï¼‰
          find "$GFX_SRC_DIR" -name "CMakeLists.txt" | xargs sed -i 's/CONFIG_FREERTOS_USE_CORE_AFFINITY//g'
        else
          echo "æœªæ‰¾åˆ°å›¾å½¢ç»„ä»¶ç›®å½•ï¼Œè·³è¿‡é€‚é…"
        fi

    - name: Install ESP-IDF v5.4 (å®˜æ–¹æ ‡å‡†å®‰è£…æµç¨‹)
      run: |
        # å®‰è£…å®˜æ–¹ä¾èµ–åŒ…
        sudo apt-get update && sudo apt-get install -y \
          git wget flex bison gperf python3 python3-pip python3-venv \
          cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0
        # å…‹éš†ESP-IDF v5.4ï¼ˆå®˜æ–¹æ¨èçš„å®‰è£…è·¯å¾„ï¼‰
        mkdir -p ~/esp && cd ~/esp
        git clone -b v5.4 --depth 1 https://github.com/espressif/esp-idf.git
        cd esp-idf
        git submodule update --init --recursive --depth 1
        # å®‰è£…ESP32-C3ç›®æ ‡æ”¯æŒ
        ./install.sh esp32c3
      timeout-minutes: 30

    - name: Build firmware (ESP-IDFå®˜æ–¹å‘½ä»¤è§„èŒƒ)
      id: build
      run: |
        # æ¿€æ´»ESP-IDFç¯å¢ƒï¼ˆå®˜æ–¹æ ‡å‡†æ–¹å¼ï¼‰
        export IDF_PATH=~/esp/esp-idf
        . "$IDF_PATH/export.sh" || { echo "æ¿€æ´»ESP-IDFç¯å¢ƒå¤±è´¥"; exit 1; }
        cd xiaozhi-esp32
        
        # å½»åº•æ¸…ç†æ„å»ºç¼“å­˜ï¼ˆESP-IDFå®˜æ–¹æ¨èï¼Œé¿å…æ®‹ç•™å¹²æ‰°ï¼‰
        idf.py fullclean
        rm -rf sdkconfig build/
        
        # è®¾ç½®ç›®æ ‡èŠ¯ç‰‡ï¼ˆå®˜æ–¹æ ‡å‡†å‘½ä»¤ï¼‰
        idf.py set-target esp32c3 || { echo "è®¾ç½®ç›®æ ‡èŠ¯ç‰‡å¤±è´¥"; exit 1; }
        
        # ä¼ é€’é…ç½®å‚æ•°ï¼ˆESP-IDFå®˜æ–¹æ”¯æŒçš„-Då‚æ•°æ ¼å¼ï¼Œæ³¨é‡Šå•ç‹¬ä¸€è¡Œï¼‰
        idf.py reconfigure \
          -DCMAKE_C_FLAGS="-Wall -Wno-error" \
          -DCMAKE_CXX_FLAGS="-Wall -Wno-error" \
          -DCONFIG_BOARD_TYPE_ESP32C3_SUPERMINI=y \
          -DCONFIG_ESPTOOLPY_FLASHSIZE_4MB=y \
          -DCONFIG_ESPTOOLPY_FLASHSIZE="4MB" \
          -DCONFIG_PARTITION_TABLE_CUSTOM=y \
          -DCONFIG_PARTITION_TABLE_CUSTOM_FILENAME="partitions/v2/4m.csv" \
          -DCONFIG_ESP_WIFI_STATIC_RX_BUFFER_NUM=3 \
          -DCONFIG_ESP_WIFI_DYNAMIC_RX_BUFFER_NUM=4 \
          -DCONFIG_USE_ESP_WAKE_WORD=y \
          -DCONFIG_SR_WN_WN9S_NIHAOXIAOZHI=y
        # æ³¨é‡Šï¼šä¿ç•™è­¦å‘Šä½†ä¸ä¸­æ–­ç¼–è¯‘ï¼ˆå•ç‹¬ä¸€è¡Œï¼Œé¿å…è¯­æ³•å†²çªï¼‰
        
        # æ„å»ºå›ºä»¶ï¼ˆå®˜æ–¹æ ‡å‡†å‘½ä»¤ï¼Œ-vå¯ç”¨è¯¦ç»†æ—¥å¿—ï¼‰
        echo "å¼€å§‹æ„å»ºï¼ˆè¯¦ç»†æ—¥å¿—æ¨¡å¼ï¼‰..."
        idf.py -v -DBOARD_NAME=esp32c3-supermini -DBOARD_TYPE=esp32c3-supermini build || { echo "æ„å»ºå¤±è´¥"; exit 1; }
        
        # æ ¡éªŒå›ºä»¶ç”Ÿæˆï¼ˆå®˜æ–¹æ¨èçš„æ ¡éªŒæ–¹å¼ï¼‰
        if [ -f "build/xiaozhi.bin" ]; then
          FIRMWARE_SIZE=$(du -h build/xiaozhi.bin | cut -f1)
          echo "âœ… æ„å»ºæˆåŠŸï¼å›ºä»¶å¤§å°: $FIRMWARE_SIZE"
          echo "size=$FIRMWARE_SIZE" >> "$GITHUB_OUTPUT"
        else
          echo "âŒ æ„å»ºå¤±è´¥ï¼šæœªç”Ÿæˆç›®æ ‡å›ºä»¶"
          exit 1
        fi
        
        # æ”¶é›†æ„å»ºæ—¥å¿—ï¼ˆè·¯å¾„è§„èŒƒï¼Œæ— ../ï¼‰
        mkdir -p build-logs
        cp -r build/log/* build-logs/ 2>/dev/null || true

    - name: Create firmware package
      run: |
        cd xiaozhi-esp32/build
        FIRMWARE_NAME="esp32c3-supermini-firmware-${{ github.event.inputs.version || github.ref_name }}"
        mkdir -p "$FIRMWARE_NAME"
        # å¤åˆ¶å…³é”®å›ºä»¶æ–‡ä»¶ï¼ˆå®˜æ–¹æ¨èçš„å›ºä»¶ç»„æˆï¼‰
        cp xiaozhi.bin "$FIRMWARE_NAME/" || { echo "å¤åˆ¶ä¸»å›ºä»¶å¤±è´¥"; exit 1; }
        cp generated_assets.bin "$FIRMWARE_NAME/" || { echo "å¤åˆ¶èµ„æºå›ºä»¶å¤±è´¥"; exit 1; }
        cp bootloader/bootloader.bin "$FIRMWARE_NAME/" || { echo "å¤åˆ¶bootloaderå¤±è´¥"; exit 1; }
        cp partition_table/partition-table.bin "$FIRMWARE_NAME/" || { echo "å¤åˆ¶åˆ†åŒºè¡¨å¤±è´¥"; exit 1; }
        
        # ç”Ÿæˆå®˜æ–¹é£æ ¼çš„çƒ§å½•è¯´æ˜
        cat > "$FIRMWARE_NAME/README.md" << EOF
        # ESP32-C3 SuperMini å›ºä»¶çƒ§å½•è¯´æ˜
        ## å›ºä»¶ä¿¡æ¯
        - ç‰ˆæœ¬: ${{ github.event.inputs.version || github.ref_name }}
        - æ„å»ºæ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
        - æ„å»ºID: ${{ github.run_id }}
        - ESP-IDFç‰ˆæœ¬: v5.4
        ## æ–‡ä»¶è¯´æ˜
        1. xiaozhi.bin - ä¸»åº”ç”¨ç¨‹åºå›ºä»¶ï¼ˆ0x10000ï¼‰
        2. bootloader.bin - å¼•å¯¼åŠ è½½ç¨‹åºï¼ˆ0x0000ï¼‰
        3. partition-table.bin - åˆ†åŒºè¡¨ï¼ˆ0x8000ï¼‰
        4. generated_assets.bin - å”¤é†’è¯èµ„æºï¼ˆ0x310000ï¼‰
        ## çƒ§å½•æ–¹æ³•ï¼ˆESP-IDFå®˜æ–¹æ¨èï¼‰
        ### ä½¿ç”¨ esptool.py
        \`\`\`bash
        esptool.py --chip esp32c3 --port /dev/ttyUSB0 --baud 460800 write_flash \
          0x0000 bootloader.bin \
          0x8000 partition-table.bin \
          0x10000 xiaozhi.bin \
          0x310000 generated_assets.bin
        \`\`\`
        ### ä½¿ç”¨ ESP Flash Download Tool
        1. ä¸‹è½½å·¥å…·ï¼šhttps://www.espressif.com/zh-hans/support/download/other-tools
        2. èŠ¯ç‰‡é€‰æ‹©ï¼šESP32-C3
        3. æŒ‰ä¸Šè¿°åœ°å€å¡«å†™çƒ§å½•åç§»é‡
        EOF
        
        # æ‰“åŒ…å›ºä»¶ï¼ˆå®˜æ–¹å¸¸ç”¨çš„tar.gzå’Œzipæ ¼å¼ï¼‰
        tar -czf "../$FIRMWARE_NAME.tar.gz" "$FIRMWARE_NAME"
        zip -r "../$FIRMWARE_NAME.zip" "$FIRMWARE_NAME"
        # è¾“å‡ºè·¯å¾„åˆ°ç¯å¢ƒå˜é‡ï¼ˆè§„èŒƒæ ¼å¼ï¼‰
        echo "firmware_zip=$(realpath "../$FIRMWARE_NAME.zip")" >> "$GITHUB_ENV"
        echo "firmware_tar=$(realpath "../$FIRMWARE_NAME.tar.gz")" >> "$GITHUB_ENV"

    - name: Create Release (GitHubå®˜æ–¹è§„èŒƒ)
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: ${{ github.event.inputs.version || github.ref_name }}
        name: ESP32-C3 SuperMini Firmware ${{ github.event.inputs.version || github.ref_name }}
        body: |
          # ESP32-C3 SuperMini å›ºä»¶å‘å¸ƒ
          ## å›ºä»¶ä¿¡æ¯
          - ç‰ˆæœ¬: ${{ github.event.inputs.version || github.ref_name }}
          - æ„å»ºæ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          - æ„å»ºID: ${{ github.run_id }}
          - ESP-IDFç‰ˆæœ¬: v5.4
          - ç›®æ ‡èŠ¯ç‰‡: ESP32-C3 (RISC-V)
          ## åŒ…å«æ–‡ä»¶
          1. **å›ºä»¶åŒ…** (.zip å’Œ .tar.gz) - å«æ‰€æœ‰æ–‡ä»¶+çƒ§å½•è¯´æ˜
          2. **å•ç‹¬å›ºä»¶** (.bin) - ä¸»ç¨‹åºã€bootloaderã€åˆ†åŒºè¡¨ã€èµ„æºæ–‡ä»¶
          3. **æ„å»ºæ—¥å¿—** - ç”¨äºè°ƒè¯•
          ## çƒ§å½•è¯´æ˜
          è¯¦è§å›ºä»¶åŒ…å†…çš„ README.mdï¼ˆéµå¾ªESP-IDFå®˜æ–¹æ¨èæµç¨‹ï¼‰
          ## å˜æ›´è®°å½•
          ${{ github.event.head_commit.message || 'æ— æ˜ç¡®å˜æ›´è®°å½•' }}
          ---
          ğŸ“Œ è¯´æ˜ï¼šè‡ªåŠ¨æ„å»ºå›ºä»¶ï¼ŒåŸºäºESP-IDF v5.4ï¼Œä»…é€‚é…ESP32-C3 SuperMiniå¼€å‘æ¿ã€‚
          æŠ€æœ¯æ”¯æŒè¯·æäº¤Issuesï¼šhttps://github.com/samnelking/xiaozhi-esp32c3-supermini/issues
        draft: false
        prerelease: ${{ contains(github.event.inputs.version, 'beta') || contains(github.event.inputs.version, 'alpha') || contains(github.event.inputs.version, 'rc') }}
        files: |
          ${{ env.firmware_zip }}
          ${{ env.firmware_tar }}
          xiaozhi-esp32/build/xiaozhi.bin
          xiaozhi-esp32/build/generated_assets.bin
          xiaozhi-esp32/build/bootloader/bootloader.bin
          xiaozhi-esp32/build/partition_table/partition-table.bin
          xiaozhi-esp32/build-logs/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload failure logs (GitHubå®˜æ–¹Artifactè§„èŒƒ)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-failure-logs-${{ github.run_id }}
        path: |
          xiaozhi-esp32/build-logs/
          xiaozhi-esp32/build/
        retention-days: 7
