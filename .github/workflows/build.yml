name: Build and Release ESP32-C3 SuperMini Firmware
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout this repo
      uses: actions/checkout@v4
      with:
        path: board-config

    - name: Checkout xiaozhi-esp32
      uses: actions/checkout@v4
      with:
        repository: samnelking/xiaozhi-esp32
        path: xiaozhi-esp32
        submodules: recursive
        fetch-depth: 1
      timeout-minutes: 30

    - name: Setup board configuration
      run: |
        mkdir -p xiaozhi-esp32/main/boards/esp32c3-supermini
        cp board-config/config.h xiaozhi-esp32/main/boards/esp32c3-supermini/
        cp board-config/config.json xiaozhi-esp32/main/boards/esp32c3-supermini/
        cp board-config/esp32c3_supermini_board.cc xiaozhi-esp32/main/boards/esp32c3-supermini/
        python3 board-config/scripts/setup_board.py xiaozhi-esp32/main

    - name: Fix compilation warnings (覆盖图形/字体组件)
      run: |
        echo "=== 修复所有报错文件的格式符问题 ==="
        # 1. 定义需要修复的文件列表（新增 gfx_obj.c 和 font_puhui_30_4.c）
        TARGET_FILES=(
          "gfx_refr.c"        # 原修复文件
          "gfx_obj.c"         # esp_emote_gfx 组件报错文件
          "font_puhui_30_4.c" # xiaozhi-fonts 组件报错文件
        )
        
        for file_pattern in "${TARGET_FILES[@]}"; do
          # 递归查找组件目录下的目标文件
          find xiaozhi-esp32 -name "$file_pattern" -type f | while read -r found_file; do
            echo "=== 处理文件: $found_file ==="
            
            # 修复1：添加 inttypes.h 头文件（PRI宏依赖，避免类型匹配警告）
            if ! grep -q "#include <<inttypes.h>" "$found_file"; then
              # 在文件开头插入头文件（兼容 C 语言语法）
              sed -i '1i#include <<inttypes.h>' "$found_file"
              echo "✅ 已添加 #include <<inttypes.h>"
            fi
            
            # 修复2：格式符类型匹配（%d→%" PRId32，%lu→%" PRIul，参考摘要5的官方建议）
            # 处理普通格式符（如 "value: %d" → "value: %" PRId32）
            sed -i 's/%d/%" PRId32/g' "$found_file"
            sed -i 's/%lu/%" PRIul/g' "$found_file"
            # 处理数组索引（如 "[%d]" → "[%" PRId32 "]"）
            sed -i 's/\[%d\]/[%"" PRId32]/g' "$found_file"
            sed -i 's/\[%lu\]/[%"" PRIul]/g' "$found_file"
            # 处理笔误（如 $iu→%" PRIul，之前发现的问题）
            sed -i 's/\$iu/%" PRIul/g' "$found_file"
            
            # 验证修复结果（打印关键行，便于调试）
            echo "修复后的格式符预览："
            grep -E '%" PRI|inttypes.h' "$found_file" || echo "无相关行"
          done
        done
        echo "=== 所有文件修复完成 ==="

    - name: Fix esp_emote_gfx compatibility (ESP32-C3 适配)
      run: |
        echo "=== 修复图形组件 API 兼容性 ==="
        # 查找 esp_emote_gfx 组件的源文件
        GFX_SRC_DIR=$(find xiaozhi-esp32 -path "*/espressif2022__esp_emote_gfx/src" -type d)
        if [ -n "$GFX_SRC_DIR" ]; then
          echo "找到图形组件目录: $GFX_SRC_DIR"
          
          # 修复1：替换 ESP32 专属头文件（如 esp_efuse_table.h → esp_efuse.h，参考摘要6）
          find "$GFX_SRC_DIR" -name "*.c" -o -name "*.h" | xargs sed -i 's/#include "esp_efuse_table.h"/#include "esp_efuse.h"/g'
          
          # 修复2：替换旧版 I2S API（若组件用了旧驱动，参考摘要6）
          find "$GFX_SRC_DIR" -name "*.c" | xargs sed -i 's/#include "driver/i2s.h"/#include "driver/i2s_std.h"/g'
          
          # 修复3：禁用 ESP32 专属配置（如多核相关，ESP32-C3 是单核）
          find "$GFX_SRC_DIR" -name "CMakeLists.txt" | xargs sed -i 's/CONFIG_FREERTOS_USE_CORE_AFFINITY//g'
        else
          echo "未找到 esp_emote_gfx 组件目录，跳过适配"
        fi

    - name: Install ESP-IDF
      run: |
        sudo apt-get update
        sudo apt-get install -y git wget flex bison gperf python3 python3-pip python3-venv cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0
        mkdir -p ~/esp
        cd ~/esp
        git clone -b v5.4 --depth 1 https://github.com/espressif/esp-idf.git
        cd esp-idf
        git submodule update --init --recursive --depth 1
        ./install.sh esp32c3
      timeout-minutes: 30

    - name: Build firmware (清理缓存 + 详细日志)
      id: build
      run: |
        export IDF_PATH=~/esp/esp-idf
        . "$IDF_PATH/export.sh" || { echo "激活环境失败"; exit 1; }
        cd xiaozhi-esp32
        
        # 关键：彻底清理旧构建（避免缓存干扰，参考摘要3）
        idf.py fullclean
        rm -rf sdkconfig build/
        
        # 设置目标芯片
        idf.py set-target esp32c3
        
        # 用 CMake 参数传递配置（替代无效的 sdkconfig 追加，参考之前的修复）
        idf.py reconfigure \
          -DCMAKE_C_FLAGS="-Wall -Wno-error" \ # 保留警告但不中断编译（便于调试）
          -DCMAKE_CXX_FLAGS="-Wall -Wno-error" \
          -DCONFIG_BOARD_TYPE_ESP32C3_SUPERMINI=y \
          -DCONFIG_ESPTOOLPY_FLASHSIZE_4MB=y \
          -DCONFIG_PARTITION_TABLE_CUSTOM=y \
          -DCONFIG_PARTITION_TABLE_CUSTOM_FILENAME="partitions/v2/4m.csv" \
          -DCONFIG_ESP_WIFI_STATIC_RX_BUFFER_NUM=3 \
          -DCONFIG_ESP_WIFI_DYNAMIC_RX_BUFFER_NUM=4 \
          -DCONFIG_USE_ESP_WAKE_WORD=y \
          -DCONFIG_SR_WN_WN9S_NIHAOXIAOZHI=y
        
        # 构建时启用详细日志（-v 选项），输出具体错误行
        echo "开始构建（启用详细日志）..."
        idf.py -v -DBOARD_NAME=esp32c3-supermini -DBOARD_TYPE=esp32c3-supermini build
        
        # 校验固件（不变）
        if [ -f "build/xiaozhi.bin" ]; then
          echo "构建成功! 固件大小: $(du -h build/xiaozhi.bin | cut -f1)"
          echo "size=$(du -h build/xiaozhi.bin | cut -f1)" >> "$GITHUB_OUTPUT"
        else
          echo "构建失败! 查看详细日志: build/log/idf_py_stderr_output_*"
          exit 1
        fi
        
        # 收集日志（路径规范，避免 Artifact 错误）
        mkdir -p build-logs
        cp -r build/log/* build-logs/ 2>/dev/null

    - name: Create firmware package
      run: |
        cd xiaozhi-esp32/build
        FIRMWARE_NAME="esp32c3-supermini-firmware-${{ github.event.inputs.version || github.ref_name }}"
        mkdir -p $FIRMWARE_NAME
        cp xiaozhi.bin $FIRMWARE_NAME/
        cp generated_assets.bin $FIRMWARE_NAME/
        cp bootloader/bootloader.bin $FIRMWARE_NAME/
        cp partition_table/partition-table.bin $FIRMWARE_NAME/
        cat > $FIRMWARE_NAME/README.md << EOF
        # ESP32-C3 SuperMini 固件烧录说明
        ## 固件信息
        - 版本: ${{ github.event.inputs.version || github.ref_name }}
        - 构建时间: $(date)
        - 构建ID: ${{ github.run_id }}
        ## 文件说明
        1. xiaozhi.bin - 主应用程序固件
        2. bootloader.bin - 引导加载程序
        3. partition-table.bin - 分区表
        4. generated_assets.bin - 资源文件（包含唤醒词）
        ## 烧录方法
        ### 使用 esptool.py
        \`\`\`bash
        esptool.py --chip esp32c3 --port /dev/ttyUSB0 write_flash \
          0x0000 bootloader.bin \
          0x8000 partition-table.bin \
          0x10000 xiaozhi.bin \
          0x310000 generated_assets.bin
        \`\`\`
        ### 使用 ESP Flash Download Tool
        1. 下载 ESP Flash Download Tool
        2. 按以下地址烧录：
           - bootloader.bin @ 0x0000
           - partition-table.bin @ 0x8000
           - xiaozhi.bin @ 0x10000
           - generated_assets.bin @ 0x310000
        EOF
        tar -czf ../$FIRMWARE_NAME.tar.gz $FIRMWARE_NAME
        zip -r ../$FIRMWARE_NAME.zip $FIRMWARE_NAME
        echo "firmware_zip=$(realpath ../$FIRMWARE_NAME.zip)" >> $GITHUB_ENV
        echo "firmware_tar=$(realpath ../$FIRMWARE_NAME.tar.gz)" >> $GITHUB_ENV

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: ${{ github.event.inputs.version || github.ref_name }}
        name: ESP32-C3 SuperMini Firmware ${{ github.event.inputs.version || github.ref_name }}
        body: |
          # ESP32-C3 SuperMini 固件发布
          ## 固件信息
          - 版本: ${{ github.event.inputs.version || github.ref_name }}
          - 构建时间: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          - 构建ID: ${{ github.run_id }}
          - 提交: ${{ github.sha }}
          ## 包含文件
          1. **固件包** (.zip 和 .tar.gz)
          2. **单独的固件文件** (.bin)
          3. **构建日志** (debugging)
          ## 烧录说明
          详见固件包内的 README.md
          ## 变更记录
          ${{ github.event.head_commit.message }}
          ---
          构建状态: ✅ 成功
          > 注意：自动构建固件，技术支持请提 Issues。
        draft: false
        prerelease: ${{ contains(github.event.inputs.version, 'beta') || contains(github.event.inputs.version, 'alpha') || contains(github.event.inputs.version, 'rc') }}
        files: |
          ${{ env.firmware_zip }}
          ${{ env.firmware_tar }}
          xiaozhi-esp32/build/xiaozhi.bin
          xiaozhi-esp32/build/generated_assets.bin
          xiaozhi-esp32/build/bootloader/bootloader.bin
          xiaozhi-esp32/build/partition_table/partition-table.bin
          xiaozhi-esp32/build-logs/*  # 修复后的日志路径

    - name: Upload artifacts (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-failure-logs
        path: |
          xiaozhi-esp32/build-logs/  # 修复后的日志路径
          xiaozhi-esp32/build/
        retention-days: 7
